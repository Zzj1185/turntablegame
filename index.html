<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•è¯è½¬ç›˜ Â· è¯¾å‰å·²åµŒå…¥å›¾ç‰‡ç‰ˆ</title>
  <style>
    :root {
      --bg: #ff6b6b;
      /* ç›˜é¢ä¸»è‰²å‚è€ƒæˆªå›¾ */
      --ink: #0b1020;
      --ghost: #ffffff18;
      --text: #0b1020;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: #ffe8e8;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: #111
    }

    .wrap {
      max-width: 1200px;
      margin: 16px auto;
      padding: 12px
    }

    /* å¸ƒå±€ï¼šå·¦è½¬ç›˜ / å³ä¾§æ ‘å½¢Startå›¾ç‰‡ */
    .stage {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px
    }

    @media (max-width: 840px) {
      .stage {
        flex-direction: column;
        gap: 12px
      }
    }

    .wheel-card {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .12);
      padding: 14px;
      position: relative
    }

    .canvas-box {
      position: relative;
      width: min(93.6vw, 672px);
      aspect-ratio: 1/1
    }

    /* æ•´ä½“æ”¾å¤§ 1.2x */
    canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* å›ºå®šæŒ‡é’ˆï¼šå³ä¾§ä¸‰è§’ */
    .pointer {
      position: absolute;
      top: 50%;
      right: -6px;
      translate: 0 -50%;
      width: 0;
      height: 0;
      border-top: 18px solid transparent;
      border-bottom: 18px solid transparent;
      border-left: 28px solid #fefefe;
      filter: drop-shadow(0 2px 6px #0007)
    }

    /* å³ä¾§Startæ ‘ç‰Œ */
    .start-wrap {
      display: grid;
      place-items: center;
    }

    .start-btn {
      display: block;
      width: min(60vw, 360px);
      max-width: 380px;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;
      transition: transform .2s ease, filter .2s ease
    }

    .start-btn:hover {
      transform: translateY(-4px) rotate(-1.5deg);
      filter: drop-shadow(0 10px 16px rgba(0, 0, 0, .2));
    }

    .start-btn:active {
      transform: translateY(0) rotate(0deg) scale(.98)
    }

    .result {
      margin-top: 10px;
      text-align: center;
      font-weight: 800;
      font-size: 20px
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="stage">
      <section class="wheel-card">
        <div class="canvas-box">
          <canvas id="wheel" width="1000" height="1000"></canvas>
          <div class="pointer" aria-hidden="true"></div>
        </div>
        <div id="result" class="result"></div>
      </section>

      <section class="start-wrap">
        <!-- ç”¨ä½ ç»™çš„æ ‘å½¢Startå›¾ç‰‡åšæŒ‰é’® -->
        <img id="startBtn" class="start-btn" alt="Start"
          src="https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdUpo8Npv96frRRtWpLWu_58rdQQ4OwACQSIAAqpXgVeMYsNYLxr6rzYE.png" />
      </section>
    </div>
  </div>
  <script></script>

  <script>
    /*
      ä½¿ç”¨è¯´æ˜ï¼ˆè¯¾å‰å‡†å¤‡ï¼‰ï¼š
      1) æŠŠä¸‹æ–¹ ASSETS å¯¹è±¡é‡Œçš„ URL æ›¿æ¢ä¸ºä½ çš„ Base64 æˆ–çº¿ä¸Šå›¾ç‰‡åœ°å€ã€‚
      2) æƒ³è¦ 8 ä¸ªæ‰‡åŒºå°±æŠŠ SECTORS=8ï¼›å¿…é¡»åŒ…å« 1ä¸ªç‚¸å¼¹ + 1ä¸ªæ˜Ÿæ˜Ÿï¼Œå…¶ä½™ä¼šæŒ‰ä½ å¡«çš„è‡ªå®šä¹‰å›¾ç‰‡è¡¥è¶³ã€‚
      3) å¦‚éœ€æ¯æ¬¡æ‰“å¼€éšæœºæ‰“ä¹±æ‰‡åŒºé¡ºåºï¼Œå°† RANDOMIZE_ON_LOAD è®¾ä¸º trueã€‚
    */

    // ===== åœ¨è¿™é‡Œç²˜è´´ä½ çš„å›¾ç‰‡ =====
    const ASSETS = {
      // â€œæ ‘å½¢Startâ€æŒ‰é’®å›¾ç‰‡
      START: "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdUpo8Npv96frRRtWpLWu_58rdQQ4OwACQSIAAqpXgVeMYsNYLxr6rzYE.png",
      BOMB: "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdVVo8NuAOL4LUnnNzTR6sELxzJi1UgACTSIAAqpXgVemsUpahGvLGTYE.png",  // â† ç‚¸å¼¹
      STAR: "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdVRo8Nt_FvxHJWYlPRu2TeygJdZVwwACTCIAAqpXgVdm1QLI8Bo6azYE.png"   // â† æ˜Ÿæ˜Ÿ
    };

    // è‡ªå®šä¹‰æ‰‡åŒºå›¾ç‰‡ï¼ˆé™¤ç‚¸å¼¹/æ˜Ÿæ˜Ÿä¹‹å¤–ï¼‰
    const CUSTOM_IMAGES = [
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZRo8OYRVmeduMKqHCJRrUeP-O0fBgACjSIAAqpXgVdPLQsOPM3t1zYE.png",
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZJo8OYRN6a5fdIrU2L5CPyQHI8JAAOLIgACqleBVzO8HrVW7UJHNgQ.png",
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZBo8OYR-Cb_49M0WZs5vtTBOD3RwwACiSIAAqpXgVeiwD4X2lI4azYE.png",
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZNo8OYRKh8DnbNXuAS4jK_gqQfciQACjCIAAqpXgVc1HHni_5oI9jYE.png",
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZFo8OYRoCOZQMStQ0B4UmOhknQ3oQACiiIAAqpXgVfcO4fL4Ih3RzYE.png",
      "https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAAEDdZNo8OYRKh8DnbNXuAS4jK_gqQfciQACjCIAAqpXgVc1HHni_5oI9jYE.png",
    ];

    const SECTORS = 8;                 // æ‰‡åŒºæ•°é‡ï¼ˆå»ºè®® 6 / 8 / 10 / 12ï¼‰
    const RANDOMIZE_ON_LOAD = false;   // æ˜¯å¦åœ¨åŠ è½½æ—¶éšæœºæ‰“ä¹±æ‰‡åŒºé¡ºåº

    // ===== è½¬ç›˜å¼•æ“ï¼ˆç”»å›¾/è½¬åŠ¨/å£°éŸ³ï¼‰ =====
    const TAU = Math.PI * 2;
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const R = canvas.width / 2 - 6;

    // æ„å»ºæ‰‡åŒºæ•°æ®ï¼šç¡®ä¿åŒ…å« 1 ä¸ªç‚¸å¼¹ + 1 ä¸ªæ˜Ÿæ˜Ÿ
    function buildSlices() {
      const imgs = [];

      function mk(url, label = "") {
        if (!url) return null;
        const im = new Image();
        im.src = url;
        return { img: im, label };
      }

      imgs.push(mk(ASSETS.BOMB, 'Bomb'));
      imgs.push(mk(ASSETS.STAR, 'Star'));

      for (const u of CUSTOM_IMAGES) {
        if (u) imgs.push(mk(u, ''));
      }

      // è‹¥ä¸è¶³ï¼Œä½¿ç”¨ç©ºç™½å ä½
      while (imgs.length < SECTORS) {
        imgs.push(mk('', ''));
      }

      // åªå–å‰ SECTORS ä¸ª
      let arr = imgs.slice(0, SECTORS);
      if (RANDOMIZE_ON_LOAD) {
        arr = shuffle(arr);
      }
      return arr;
    }

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = (Math.random() * (i + 1)) | 0;
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // âœ… é¢„åŠ è½½å½“å‰ slices é‡Œçš„æ‰€æœ‰å›¾ç‰‡ï¼ŒåŠ è½½å®Œåå†ç”»
    function preloadAllImages(slices) {
      const tasks = [];

      for (const s of slices) {
        if (!s || !s.img || !s.img.src) continue;

        tasks.push(
          new Promise(resolve => {
            if (s.img.complete) return resolve(); // å·²åŠ è½½
            s.img.onload = () => resolve();
            s.img.onerror = () => resolve();
          })
        );
      }

      return Promise.all(tasks);
    }

    let slices = buildSlices();
    let angle = 0, spinning = false, angVel = 0, lastSeg = -1;
    const palette = ["#ff7474", "#ffc2c2", "#ff9e9e", "#ffd0d0", "#ffa0a0", "#ffcaca", "#ffb3b3", "#ffdcdc"]; // æ¸©æš–åç²‰

    function draw() {
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0, 0, w, h);
      ctx.save();
      ctx.translate(w / 2, h / 2);
      ctx.rotate(angle);

      const step = TAU / slices.length;

      // å¤–åœˆ
      ctx.beginPath();
      ctx.arc(0, 0, R + 4, 0, TAU);
      ctx.fillStyle = "#feecec";
      ctx.fill();

      for (let i = 0; i < slices.length; i++) {
        const a0 = i * step, a1 = a0 + step, mid = a0 + step / 2;

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, R, a0, a1);
        ctx.closePath();
        ctx.fillStyle = palette[i % palette.length];
        ctx.fill();

        // è¾¹çº¿
        ctx.strokeStyle = '#00000028';
        ctx.lineWidth = 2;
        ctx.stroke();

        const s = slices[i];
        // å›¾ç‰‡
        if (s && s.img && s.img.src) {
          const rImg = R * 0.63;
          const size = Math.min(130, R * 0.36) * 1.5; // æ”¾å¤§å›¾ç‰‡ä¸ºåŸæ¥çš„1.5å€
          ctx.save();
          ctx.rotate(mid);
          ctx.translate(rImg, 0);
          ctx.rotate(-Math.PI / 2);
          try {
            ctx.drawImage(s.img, -size / 2, -size / 2, size, size);
          } catch (e) { }
          ctx.restore();
        }
      }

      // ä¸­å¿ƒå°åœ†
      ctx.beginPath();
      ctx.arc(0, 0, R * 0.08, 0, TAU);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.lineWidth = 4;
      ctx.strokeStyle = "#00000010";
      ctx.stroke();

      ctx.restore();
    }

    // å‘½ä¸­æ‰‡åŒºç´¢å¼•ï¼ˆæŒ‡é’ˆåœ¨å³ä¾§0å¼§åº¦æ–¹å‘ï¼‰
    function segAtPointer() {
      const step = TAU / slices.length;
      let norm = angle % TAU;
      if (norm < 0) norm += TAU;
      return Math.floor((TAU - norm) / step) % slices.length;
    }

    // WebAudio: æ»´ç­”å£°
    let audioCtx = null;
    function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function tick() {
      try {
        ensureAudio();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = 'square';
        o.frequency.value = 900 + Math.random() * 80;
        g.gain.value = 0.0001;
        o.connect(g);
        g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.14, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.08);
        o.start(t);
        o.stop(t + 0.09);
      } catch (e) { }
    }

    function animate() {
      if (!spinning) {
        draw();
        return;
      }
      angle += angVel;
      angVel *= 0.985;
      angVel -= 0.0003;
      if (angVel < 0.003) {
        angVel -= 0.0006;
      }

      const idx = segAtPointer();
      if (idx !== lastSeg) {
        lastSeg = idx;
        tick();
      }

      if (angVel <= 0) {
        spinning = false;
        angVel = 0;
        draw();
        return;
      }

      draw();
      requestAnimationFrame(animate);
    }

    function startSpin() {
      if (spinning) return;
      ensureAudio();
      document.getElementById('result').textContent = '';
      lastSeg = -1;
      angVel = 0.38 + Math.random() * 0.24;
      spinning = true;
      requestAnimationFrame(animate);
    }

    function showResult(i) {
      const s = slices[i];
      const label = s?.label || '';
      let text = `ğŸ‰ ç»“æœï¼šæ‰‡åŒº ${i + 1}`;
      if (label) {
        text += `ï¼ˆ${label}ï¼‰`;
      }

      // æ ¹æ®ç‚¸å¼¹/æ˜Ÿæ˜Ÿç»™ä¸€ç‚¹æç¤º
      const src = s?.img?.src || '';
      if (src && ASSETS.BOMB && src.includes(ASSETS.BOMB.slice(0, 40))) text = 'ğŸ’£ Boom!ï¼ˆç‚¸å¼¹ï¼‰';
      if (src && ASSETS.STAR && src.includes(ASSETS.STAR.slice(0, 40))) text = 'â­ Lucky Star!ï¼ˆæ˜Ÿæ˜Ÿï¼‰';

      document.getElementById('result').textContent = text;
    }

    // ç»‘å®š Start å›¾ç‰‡
    const startEl = document.getElementById('startBtn');
    startEl.addEventListener('click', startSpin);

    // âœ… é¡µé¢åŠ è½½æ—¶ï¼šå…ˆé¢„åŠ è½½æ‰€æœ‰æ‰‡åŒºå›¾ç‰‡ï¼Œå†ç»˜åˆ¶ä¸€æ¬¡
    preloadAllImages(slices).then(() => {
      draw();
    });

    // å¦‚æœä½ åæ¥åœ¨ä»£ç é‡Œæ›¿æ¢äº† CUSTOM_IMAGESï¼Œå¯è°ƒç”¨ rebuild() é‡å»º
    function rebuild() {
      slices = buildSlices();
      angle = 0;
      preloadAllImages(slices).then(() => {
        draw();
      });
    }
  </script>
</body>

</html>
